name: macOS DMG Release

on:
  push:
    branches:
      - 'mac*'

permissions:
  contents: write

jobs:
  dmg:
    name: Build macOS DMG
    runs-on: macos-14

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'

      - name: Build app
        run: ./mvnw -B clean package --file pom.xml

      - name: Create DMG (jpackage)
        run: |
          cd target
          jpackage --verbose \
            --type dmg \
            --name mcalert \
            --input quarkus-app \
            --description "Read Prometheus endpoints and show status as toolbar icon" \
            --icon ../mcalert.icns \
            --java-options "-Dapple.awt.application.appearance=system" \
            --main-jar quarkus-run.jar

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcalert-dmg
          path: target/*.dmg
          if-no-files-found: error

# Alternative, having release version
#  dmg-release:
#    runs-on: macos-14
#
#    steps:
#      - uses: actions/checkout@v4
#
#      - name: Set up JDK 25
#        uses: actions/setup-java@v4
#        with:
#          java-version: '25'
#          distribution: 'temurin'
#
##      - name: Read version from pom.xml
##        id: pom
##        shell: bash
##        run: |
##          VERSION="$(./mvnw -q -DforceStdout help:evaluate -Dexpression=project.version)"
##          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
##
##      - name: Verify tag matches pom version
##        shell: bash
##        run: |
##          TAG="${GITHUB_REF_NAME}"          # e.g. v1.2.3
##          VERSION="${{ steps.pom.outputs.version }}"
##          if [ "$TAG" != "v$VERSION" ]; then
##            echo "Tag '$TAG' does not match pom.xml version '$VERSION' (expected 'v$VERSION')."
##            exit 1
##          fi
#
#      - name: Build app
#        run: ./mvnw -B clean package --file pom.xml
#
#      - name: Create DMG (jpackage)
#        shell: bash
#        run: |
#          cd target
#          jpackage --verbose \
#            --type dmg \
#            --name mcalert \
#            --input quarkus-app \
#            --description "Read Prometheus endpoints and show status as toolbar icon" \
#            --icon ../mcalert.icns \
#            --java-options "-Dapple.awt.application.appearance=system" \
#            --main-jar quarkus-run.jar
#
#      - name: Publish GitHub Release (attach DMG)
#        uses: softprops/action-gh-release@v2
#        with:
#          tag_name: v${{ steps.pom.outputs.version }}
#          name: v${{ steps.pom.outputs.version }}
#          files: target/*.dmg
#          fail_on_unmatched_files: true
#          generate_release_notes: true